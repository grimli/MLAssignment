---
title: "Machine Learning Course Project"
author: "Edoardo Bompiani"
date: "04 luglio 2017"
output: html_document
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = TRUE)
```

## Executive Summary 
The goal of this project is to analyze the data in the WLE dataset to produce a model that predict the **class** variable from a subset of the other fields describing how the model was built, how cross validation was used, what is  the expected out of sample error, the reasons for the choices done. The prediction model will be used to predict the 20 different test cases too.

The class variable describes the exercise execution: **A** indicating a correct execution and the other classes indicating 4 different common errors in wheight lift. A more detailed description of the dataset can be get here http://groupware.les.inf.puc-rio.br/har. 

The **W**eight **L**ifting **E**xercises (WLE) Dataset is is licensed under the Creative Commons license (CC BY-SA) and gently made availabel by Velloso, E.; Bulling, A.; Gellersen, H.; Ugulino, W.; Fuks, H. as support to the article.

*Velloso, E.; Bulling, A.; Gellersen, H.; Ugulino, W.; Fuks, H. Qualitative Activity Recognition of Weight Lifting Exercises. Proceedings of 4th International Conference in Cooperation with SIGCHI (Augmented Human '13) . Stuttgart, Germany: ACM SIGCHI, 2013.*

## Preprocessing
The **caret** library is loaded to be used in the analysis and the working directory is set to the directory containing the downloaded data

```{r}
library(caret)
library(dplyr)
```

The dataset is loaded from two files and copied in two variables
```{r}
destfile_test <- "./pml-testing.csv"
destfile_train <- "./pml-training.csv"

if(!file.exists(destfile_test)){
    res <- tryCatch(download.file("https://d396qusza40orc.cloudfront.net/predmachlearn/pml-testing.csv",
                              destfile="./data/pml-testing.csv",
                              method="auto"),
                error=function(e) 1)
}

if(!file.exists(destfile_train)){
    res <- tryCatch(download.file("https://d396qusza40orc.cloudfront.net/predmachlearn/pml-training.csv",
                              destfile="./data/pml-training.csv",
                              method="auto"),
                error=function(e) 1)
}

dfTrain <- read.csv(destfile_train)
dfTest <- read.csv(destfile_test)
``` 

Several preprocessing activity are required to avoid problem with this dataset.
To avoid problems with the sampling we'll not consider variables with near to zero variancd
 
```{r}
dfTrain <- dfTrain <- dfTrain[,-nearZeroVar(dfTrain)]
```

Too incomplete variables are not considered
```{r}
dfTrain <- dfTrain[, complete.cases(t(dfTrain))]
```

Some variables are tag used to identify the subject or the measure and should not be used to determinate the classe
```{r}
dfTrain <- dfTrain[, -grep("X", names(dfTrain))]
dfTrain <- dfTrain[, -grep("user_name", names(dfTrain))]
```

Some variables are used to determinate the temporal sequence in the exercises. These variables would reflect the order in the exercise execution and would determinate the class just because the exercises are executed in a specific order.  
```{r}
dfTrain <- dfTrain[, -grep("timestamp", names(dfTrain))]
```

A partition in the training set is created to have a subset to use in the comparison of the models
```{r}
set.seed(2740)
inTrain <- createDataPartition(y=dfTrain$classe, p=.7, list=FALSE)
dfTrainT <- dfTrain[inTrain, ]
dfTrainV <- dfTrain[-inTrain, ]
```

The same subset of variables is selected in the test data too
```{r}
variables <- names(dfTrain)
dfTest <- dfTest[,names(dfTest) %in% variables]
```

## Analysis
Several predicion models are available. Some have been picked up considering the execution time too. 
The resulting prediction are compared and a combined model is built.

### Random Tree
```{r}
set.seed(1332)
fitRT <- train( classe ~ ., data = dfTrainT, method = "rpart", maxdepth=20)
predRT <- predict( fitRT, newdata = dfTrainV )
cmRT <- confusionMatrix(predRT, dfTrainV$classe)
cmRT
```


```{r}
### Generalized partial least square
### not available for this verion of R
#fitLM <- train( classe ~ ., data = dfTrainT, method = "gpls")
#predLM <- predict( fitLM, newdata = dfTrainV )
#cmLM <- confusionMatrix(predLM, dfTrainV$classe)
#cmLM
```

```{r}
## Random Forest
### Generalized partial least square
#fitRF <- train( classe ~ ., data = dfTrainT, method = "rf")
#predRF <- predict( fitRF, newdata = dfTrainV )
#cmRF <- confusionMatrix(predRF, dfTrainV$classe)
#cmRF

## Boosting
fitBT <- train( classe ~ ., data = dfTrainT, method = "gbm", verbose = FALSE)
predBT <- predict( fitBT, newdata = dfTrainV )
cmBT <- confusionMatrix(predBT, dfTrainV$classe)
cmBT

## Linear Discriminant analysis
fitLDA <- train( classe ~ ., data = dfTrainT, method = "lda")
predLDA <- predict( fitLDA, newdata = dfTrainV )
cmLDA <- confusionMatrix(predLDA, dfTrainV$classe)
cmLDA

## combinate
predDF <- data.frame(predRF,predBT, predLDA, classe=dfTrainV$classe)
fitComb <- train(classe ~ . , data = predDF, method="rf")
predComb <- predict(fitComb, dfTrainV)
cmComb <- confusionMatrix(predComb, dfTrainV$classe)
cmComb

cmRT$overall
cmLM$overall
cmRF$overall
cmBT$overall
cmLDA$overall
cmComb$overall
```